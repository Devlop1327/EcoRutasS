<div class="map-layout">
  <aside class="side">
    <a class="back-btn" routerLink="/dashboard" aria-label="Volver al dashboard" title="Volver">
      <mat-icon class="material-symbols-rounded">arrow_back</mat-icon>
    </a>
    <details class="collapsible" open>
      <summary>
        <span class="title">Rutas disponibles</span>
        <span class="count">{{ rutas().length }}</span>
        <span class="caret" aria-hidden>â–¾</span>
      </summary>
      @if (loading()) {
        <div class="muted">Cargando rutas...</div>
      } @else if (error()) {
        <div class="error">{{ error() }}</div>
      } @else {
        <div class="card">
          <ul class="list">
            @for (r of rutas(); track r.id) {
              <li class="item"
                  [class.selected]="selectedRutaId() === r.id"
                  (click)="selectRuta(r.id)"
                  title="Seleccionar ruta">
                <span class="dot route"></span>
                <span class="text">{{ r.nombre }}</span>
                <span class="chev">â€º</span>
              </li>
            }
            @if (rutas().length === 0) {
              <li class="muted">Sin rutas</li>
            }
          </ul>
        </div>
      }
    </details>

    <details class="collapsible mt" open appConductorOnly>
      <summary>
        <span class="title">VehÃ­culos</span>
        <span class="count">{{ vehiculos().length }}</span>
        <span class="caret" aria-hidden>â–¾</span>
      </summary>
      @if (loading()) {
        <div class="muted">Cargando...</div>
      } @else {
        <div class="card">
          <ul class="list">
            @for (v of vehiculos(); track v.id) {
              <li class="item vehicle"
                  [class.selected]="selectedVehiculoId() === v.id"
                  (click)="selectVehiculo(v.id)"
                  title="Seleccionar vehÃ­culo">
                <span class="icon">ðŸš›</span>
                <span class="text">{{ v.placa || v.id }}</span>
                <span class="chev">â€º</span>
              </li>
            }
            @if (vehiculos().length === 0) {
              <li class="muted">Sin vehÃ­culos</li>
            }
          </ul>
        </div>
      }
    </details>

    <!-- Controles de conductor -->
    <div class="controls mt" appConductorOnly [appConductorOnlyDisabledMode]="true">
      <button class="btn btn-primary" (click)="iniciarRecorrido()"
              [disabled]="!selectedRutaId() || !selectedVehiculoId() || !!currentRecorridoId() || isStarting()"
              title="Iniciar recorrido">
        <span class="btn-icon">â–¶</span>
        <span>Iniciar Recorrido</span>
      </button>
      <button class="btn btn-danger" (click)="finalizarRecorrido()"
              [disabled]="!currentRecorridoId()"
              title="Finalizar recorrido">
        <span class="btn-icon">â– </span>
        <span>Finalizar</span>
      </button>
      @if (currentRecorridoId()) {
        <div class="muted small status">
          Ruta en recorrido: <strong>{{ currentRecorridoRutaName() || 'â€”' }}</strong>
        </div>
      }
    </div>
  </aside>
  <section class="map-wrap">
    <div id="map" class="map"></div>
  </section>
</div>
