<div class="login-container">
  <div class="auth-shell">
    <div class="form-panel">
      <mat-card class="login-card">
        <mat-card-header>
          <div mat-card-avatar class="eco-avatar">
            <mat-icon class="material-symbols-rounded">person_add</mat-icon>
          </div>
          <mat-card-title>Crea Tu Cuenta</mat-card-title>
          <mat-card-subtitle>Únete a EcoRutas y aporta al cambio</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (error()) {
            <div class="error">{{ error() }}</div>
          }

          <form [formGroup]="form" (ngSubmit)="onSubmit()" class="stack">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Nombre de usuario</mat-label>
              <input matInput formControlName="username" />
              @if (form.controls.username.errors?.['required'] && form.controls.username.touched) {
                <mat-error>El nombre de usuario es requerido</mat-error>
              }
              @if (form.controls.username.errors?.['minlength'] && form.controls.username.touched) {
                <mat-error>Mínimo 3 caracteres</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Correo</mat-label>
              <input matInput type="email" formControlName="email" />
              @if (form.controls.email.errors?.['required'] && form.controls.email.touched) {
                <mat-error>El correo es requerido</mat-error>
              }
              @if (form.controls.email.errors?.['email'] && form.controls.email.touched) {
                <mat-error>Ingresa un correo válido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Contraseña</mat-label>
              <input matInput [type]="showPassword() ? 'text' : 'password'" formControlName="password" />
              <button mat-icon-button matSuffix type="button" (click)="showPassword.set(!showPassword())" class="password-toggle">
                <mat-icon class="material-symbols-rounded">{{ showPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              @if (form.controls.password.errors?.['required'] && form.controls.password.touched) {
                <mat-error>La contraseña es requerida</mat-error>
              }
              @if (form.controls.password.errors?.['minlength'] && form.controls.password.touched) {
                <mat-error>Mínimo 6 caracteres</mat-error>
              }
            </mat-form-field>

            <mat-progress-bar mode="determinate" [color]="passwordStrengthColor()" [value]="passwordStrength()"></mat-progress-bar>
            <div class="helper muted">Usa mayúsculas, números y símbolos para una contraseña más fuerte.</div>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Confirmar contraseña</mat-label>
              <input matInput [type]="showPasswordConfirm() ? 'text' : 'password'" formControlName="confirmPassword" />
              <button mat-icon-button matSuffix type="button" (click)="showPasswordConfirm.set(!showPasswordConfirm())" class="password-toggle">
                <mat-icon class="material-symbols-rounded">{{ showPasswordConfirm() ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              @if (form.controls.confirmPassword.errors?.['required'] && form.controls.confirmPassword.touched) {
                <mat-error>Confirma tu contraseña</mat-error>
              }
              @if (passwordMismatch() && form.controls.confirmPassword.touched) {
                <mat-error>Las contraseñas no coinciden</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Rol</mat-label>
              <mat-select formControlName="role">
                <mat-option value="cliente">Cliente</mat-option>
                <mat-option value="conductor">Conductor</mat-option>
                <mat-option value="admin">Administrador</mat-option>
              </mat-select>
            </mat-form-field>

            <div class="row-between">
              <mat-checkbox formControlName="terms">Acepto los términos y condiciones</mat-checkbox>
            </div>

            <div class="actions">
              <button mat-raised-button color="primary" type="submit" [disabled]="loading() || form.invalid || passwordMismatch()">
                @if (loading()) { 
                  <mat-spinner diameter="20"></mat-spinner> 
                } @else {
                  <ng-container>
                    <mat-icon class="material-symbols-rounded btn-leading">how_to_reg</mat-icon>
                    <span>Crear cuenta</span>
                  </ng-container>
                }
              </button>
              <a mat-button routerLink="/auth/login">¿Ya tienes cuenta? Inicia sesión</a>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>
    <div class="visual-panel">
      <div class="visual-content">
        <mat-icon class="visual-icon material-symbols-rounded">eco</mat-icon>
        <h2>EcoRutas</h2>
        <p>Sumemos esfuerzos para una ciudad más limpia.</p>
      </div>
    </div>
  </div>
</div>
